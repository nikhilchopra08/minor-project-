// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  DEALER
  ADMIN
}

enum QuoteStatus {
  PENDING
  RESPONDED
  REVISED
  ACCEPTED
  REJECTED
  EXPIRED
}

enum RenovationType {
  PANEL_CLEANING
  INVERTER_UPGRADE
  EFFICIENCY_IMPROVEMENT
  WIRING_SAFETY_UPGRADE
  PANEL_REPLACEMENT
  SOLAR_MIGRATION
  COMPLETE_RENOVATION
  CUSTOM
}

enum BookingStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  RESCHEDULED
}

enum SlotStatus {
  AVAILABLE
  BOOKED
  BLOCKED
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  role      Role     @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  userProfile   UserProfile?
  dealerProfile DealerProfile?
  refreshTokens RefreshToken[]

  services Service[]
  packages Package[]

  // Quote relations with explicit names
  quotesAsUser   Quote[]    @relation("UserQuotes")
  quotesAsDealer Quote[]    @relation("DealerQuotes")
  
  // Booking relations with explicit names
  bookingsAsUser   Booking[] @relation("UserBookings")
  bookingsAsDealer Booking[] @relation("DealerBookings")
  
  // Availability relation
  availabilitySlots DealerAvailability[]

  @@index([createdAt])
  @@index([role])
}

model UserProfile {
  id       String  @id @default(uuid())
  userId   String  @unique
  fullName String?
  phone    String? @unique
  city     String?
  state    String?
  address  String?

  user User @relation(fields: [userId], references: [id])
}

model DealerProfile {
  id            String  @id @default(uuid())
  userId        String  @unique
  businessName  String
  businessEmail String?
  phone         String? @unique
  gstNumber     String? @unique
  address       String?
  city          String?
  state         String?
  description   String?

  user User @relation(fields: [userId], references: [id])
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime

  user User @relation(fields: [userId], references: [id])
}

model Service {
  id          String   @id @default(uuid())
  name        String
  description String?
  category    String
  price       Float?
  duration    Int? // in hours
  isActive    Boolean  @default(true)
  dealerId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  dealer   User             @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  packages PackageService[]
  bookings Booking[]  

  @@map("services")
  @@index([createdAt])
  @@index([dealerId])
  @@index([isActive])
}

model Package {
  id          String   @id @default(uuid())
  name        String
  description String?
  price       Float
  duration    Int? // in days
  isActive    Boolean  @default(true)
  dealerId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  dealer   User             @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  services PackageService[]

  @@map("packages")
  @@index([createdAt])
  @@index([dealerId])
  @@index([isActive])
}

model PackageService {
  id        String @id @default(uuid())
  packageId String
  serviceId String

  package Package @relation(fields: [packageId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([packageId, serviceId])
  @@map("package_services")
}

model Quote {
  id            String         @id @default(uuid())
  userId        String
  dealerId      String
  status        QuoteStatus    @default(PENDING)
  
  // User requirements
  location      String
  currentSetup  String?
  powerUsage    String
  renovationType RenovationType
  description   String?
  images        String[]       // URLs to uploaded images
  
  // Dealer response
  proposedServices String?     // Description of proposed services
  totalAmount     Float?
  breakdown       Json?        // JSON array of service breakdown
  timeline        String?      // Estimated timeline
  warranty        String?      // Warranty information
  notes           String?      // Additional notes
  
  // Revision history
  revisions       Json?        // Array of revision history
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  expiresAt       DateTime?    // Quote expiration date

  user            User         @relation("UserQuotes", fields: [userId], references: [id], onDelete: Cascade)
  dealer          User         @relation("DealerQuotes", fields: [dealerId], references: [id], onDelete: Cascade)
  // booking         Booking?

  @@map("quotes")
  @@index([userId])
  @@index([dealerId])
  @@index([status])
  @@index([createdAt])
}

model Booking {
  id              String        @id @default(uuid())
  serviceId       String
  userId          String
  dealerId        String
  status          BookingStatus @default(SCHEDULED)

  location      String?
  contactPhone  String?
  contactEmail  String?

  // Scheduling
  scheduledDate   DateTime
  estimatedHours  Int
  startTime       String
  endTime         String
  
  // Service details
  services        Json         // Array of services from quote breakdown
  totalAmount     Float
  specialNotes    String?
  
  // Tracking
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  completedAt     DateTime?
  cancelledAt     DateTime?
  cancellationReason String?

  // Relations with explicit names
  user            User         @relation("UserBookings", fields: [userId], references: [id], onDelete: Cascade)
  dealer          User         @relation("DealerBookings", fields: [dealerId], references: [id], onDelete: Cascade)
  service         Service      @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@map("bookings")
  @@index([userId])
  @@index([dealerId])
  @@index([scheduledDate])
  @@index([status])
}

model DealerAvailability {
  id        String   @id @default(uuid())
  dealerId  String
  date      DateTime // Date without time
  isAvailable Boolean @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  dealer    User     @relation(fields: [dealerId], references: [id], onDelete: Cascade)

  @@map("dealer_availabilities")
  @@unique([dealerId, date])
  @@index([dealerId])
  @@index([date])
}